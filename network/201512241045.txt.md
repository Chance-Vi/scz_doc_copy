27.3 如何用Wireshark解密HTTPS报文

http://scz.617.cn/network/201512241045.txt

Q:

工作中经常会用到Wireshark来抓包，但是一些SSL加密的数据无法直接查看。之前的
方式是你要有目标服务器的私钥并且在Wireshark里设置一下，但你很可能没有私钥，
而且现在的SSL协议大都开始使用前向密钥交换算法，用私钥解密不再可行。

A: gzp@nsfocus 2015-12-24 10:45

Firefox、Chrome可以通过设置SSLKEYLOGFILE环境变量导出所有的会话密钥，估计是
为了方便调试。Wireshark可以通过这种格式的密钥来解密。

set SSLKEYLOGFILE=<path>\sslkey.log

Wireshark->Edit->Preferences->Protocols->SSL->(Pre)-Master-Secret log filename-><path>\sslkey.log

start Firefox
start Chrome

访问任意HTTPS站点，用Wireshark抓包，已经可以同步解密，除了"Reassembled TCP"
还能看到"Decrypted SSL data"。除了"Follow TCP Stream"，还能用"Follow SSL Stream"。

为了方便调试，可以在系统变量中增加SSLKEYLOGFILE。<path>支持UNC路径。

D: scz

参看:

NSS Key Log Format
https://developer.mozilla.org/en-US/docs/Mozilla/Projects/NSS/Key_Log_Format

Your Browser Knows All Your Secrets
https://isc.sans.edu/forums/diary/Psst+Your+Browser+Knows+All+Your+Secrets/16415/

SSL/TLS: What's Under the Hood
http://www.sans.org/reading-room/whitepapers/authentication/ssl-tls-whats-hood-34297

The First Few Milliseconds of an HTTPS Connection
http://www.moserware.com/2009/06/first-few-milliseconds-of-https.html

sslkey.log形如:

# Comment lines begin with a sharp character
RSA <space> <16 bytes of hex encoded encrypted pre master secret> <space> <96 bytes of hex encoded pre master secret>
CLIENT_RANDOM <space> <64 bytes of hex encoded client_random> <space> <96 bytes of hex encoded master secret>

The RSA form allows ciphersuites using RSA key-agreement to be logged and
is supported in shipping versions of Wireshark. The CLIENT_RANDOM format
allows other key-agreement algorithms to be logged but is only supported
starting with Wireshark 1.8.0

The CLIENT_RANDOM entry is for Diffie-Hellman negotiated sessions and the
RSA entry is for sessions using RSA or DSA key exchange.

示例:

# SSL/TLS secrets log file, generated by NSS
CLIENT_RANDOM 754027ec6cb6899bc3fc7d98979c2589735c1146181d9418706881a3a022fbf2 24d12b81bf9ea2b1dd0c411ab875097ed5b8bd1716a7a8ebe93907129f473aa97797dae1743c3e1f2625a82e65a6f1cb

发散一下。

Firefox、Chrome之外的其他进程，假设有SSL/TLS通信，有时同样有用Wireshark抓
包查看明文的需求，毕竟那个界面比较熟悉。

sslkey.log的格式是明确的:

RSA <16 bytes of hex encoded encrypted pre master secret> <96 bytes of hex encoded pre master secret>
CLIENT_RANDOM <64 bytes of hex encoded client_random> <96 bytes of hex encoded master secret>

利用调试器或其他进程注入、Hook技术获取"pre master secret"、"client_random"、
"master secret"，填写sslkey.log，就能用Wireshark解密报文。这里的原始需求是
方便地旁路观察SSL/TLS明文数据，因此不考虑调试本身就可以获取明文数据这个事
实。

Firefox的Live HTTP Headers插件可以查看HTTPS明文。